<!--
	FindBugs Ant build script.
	Based on original FindBugs Ant Script by Mike Fagan.
	Rewritten 1/5/2005 by David Hovemeyer.
-->

<project name="findbugs" default="build">
	
	<property file="build.properties"/>
	
	<property name="jar.dir" value="lib"/>
	<property name="plugin.dir" value="plugin"/>
	<property name="classes.dir" value="build/classes"/>
	<property name="scripts.dir" value="bin"/>
	<property name="src.dir" value="src/java"/>
	<property name="toolsrc.dir" value="src/tools"/>
	<property name="scriptsrc.dir" value="src/scripts"/>
	<property name="xslsrc.dir" value="src/xsl"/>
	<property name="junitsrc.dir" value="src/junit"/>
	<property name="etc.dir" value="etc"/>
	<property name="test.dir" value="test"/>
	<property name="pkg.base" value="edu/umd/cs/findbugs"/>
	<property name="engine.jar" value="${jar.dir}/findbugs.jar"/>
	<property name="coreplugin.jar" value="${plugin.dir}/coreplugin.jar"/>
	<property name="gui.jar" value="${jar.dir}/findbugsGUI.jar"/>
	<property name="test.jar" value="${test.dir}/dumb.jar"/>
	<property name="junittests.jar" value="build/junittests.jar"/>
	<property name="scripts.props" value="etc/script.properties"/>
	<property name="scripts.stamp" value="build/scripts.stamp"/>
	
	<path id="findbugs.classpath">
	    <pathelement location="${jar.dir}/bcel.jar"/>
	    <pathelement location="${jar.dir}/dom4j-full.jar"/>
	    <pathelement location="${jar.dir}/AppleJavaExtensions.jar"/>
	    <pathelement location="${jar.dir}/junit.jar"/>
	</path>
	
	<path id="tools.classpath">
		<pathelement location="${classes.dir}"/>
		<path refid="findbugs.classpath"/>
	</path>

	<!-- Some of the test classes require a real JDK 1.5 -->
	<condition property="jsr14.excludes"
	           value="IgnoredReturnValue.java,JSR166.java,TryLock.java,UnnecessaryMathTest.java">
		<equals arg1="${build.compiler}"
		        arg2="com.cortexeb.Jsr14CompilerAdapter"/>
	</condition>

	<!-- Default target builds scripts and jars, allowing execution using
		the working directory as FINDBUGS_HOME.  Also build test case jarfile. -->
	<target name="build" depends="jars,scripts,testjar"/>
	
	<!-- Rebuild from scratch. -->
	<target name="rebuild" depends="clean,build"/>

	<!-- Compile Java source files, and copy other files (properties,
		images, html, XSL stylesheets) that need to be part of the codebase. -->
	<target name="classes">
		<mkdir dir="${classes.dir}"/>
		<!-- Compile Java source files. -->
		<javac srcdir="${src.dir}"
				destdir="${classes.dir}"
				source="1.5"
				target="jsr14"
				debug="on">
			<classpath refid="findbugs.classpath"/>
		</javac>
		<!-- Copy codebase data files. -->
		<copy todir="${classes.dir}">
			<fileset dir="${src.dir}">
				<include name="**/*.properties"/>
				<include name="**/*.png"/>
				<include name="**/*.html"/>
			</fileset>
			<fileset dir="${etc.dir}">
				<include name="summary.xsl"/>
			</fileset>
			<fileset dir="${xslsrc.dir}">
				<include name="*.xsl"/>
			</fileset>
		</copy>
		<!-- Compile JUnit test cases. -->
		<javac srcdir="${junitsrc.dir}"
				destdir="${classes.dir}"
				source="1.5"
				target="jsr14"
				debug="on">
			<classpath refid="tools.classpath"/>
		</javac>
		<!-- Compile tools. -->
		<javac srcdir="${toolsrc.dir}"
				destdir="${classes.dir}"
				source="1.5"
				target="jsr14"
				debug="on"
				excludes="${pkg.base}/tools/patcomp/**">
			<classpath refid="tools.classpath"/>
		</javac>
	</target>

	<!-- Build jar files. -->
	<target name="jars" depends="classes">
		<!-- Main engine and command line jar file. -->
		<jar destfile="${engine.jar}"
				manifest="etc/MANIFEST-findbugs.MF">
			<!-- Compiled classes, properties files. -->
			<fileset dir="${classes.dir}">
				<exclude name="${pkg.base}/tools/**"/>
				<exclude name="${pkg.base}/gui/**"/>
				<exclude name="${pkg.base}/detect/**"/>
				<exclude name="${pkg.base}/tools/**"/>
				<exclude name="**/*Test.class"/> <!-- Exclude JUnit tests. -->
				<include name="**/*.class"/>
				<include name="**/*.properties"/>
				<include name="**/*.xsl"/>
			</fileset>
		</jar>
		
		<!-- Core detector plugin. -->
		<jar destfile="${plugin.dir}/coreplugin.jar">
			<fileset dir="etc">
				<include name="findbugs.xml"/>
				<include name="messages*.xml"/>
			</fileset>
			<fileset dir="${classes.dir}">
				<include name="${pkg.base}/detect/*.class"/>
			</fileset>
		</jar>
		
		<!-- Swing GUI jar file. -->
		<jar destfile="${gui.jar}"
				manifest="etc/MANIFEST-findbugsGUI.MF">
			<fileset dir="${classes.dir}">
				<include name="${pkg.base}/gui/**/*.class"/>
				<include name="${pkg.base}/gui/**/*.properties"/>
				<include name="${pkg.base}/gui/**/*.png"/>
				<include name="${pkg.base}/gui/**/*.html"/>
			</fileset>
		</jar>
	</target>
	
	<!-- See if front-end scripts need to be regenerated. -->
	<target name="checkscripts">
		<condition property="scripts.uptodate">
			<and>
				<!-- Generated scripts must be newer than src scripts -->
				<uptodate>
					<srcfiles dir="." includes="${scriptsrc.dir}/*"/>
					<mapper type="regexp"
						from="^src(/|\\)scripts(/|\\)(.*)$$"
						to="${scripts.dir}/\3"/>
				</uptodate>
				<!-- And, generated scripts must be newer than etc/script.properties -->
				<uptodate targetfile="${scripts.stamp}">
					<srcfiles file="${scripts.props}"/>
				</uptodate>
			</and>
		</condition>
	</target>
	
	<!-- Generate front-end scripts. -->
	<target name="scripts" depends="checkscripts" unless="scripts.uptodate">
		<loadproperties srcFile="${scripts.props}"/>

		<filterset id="script.filters">
			<filter token="GET_FBHOME" value="${script.get.fbhome}" />
			<filter token="SET_DEFAULT_JAVA" value="${script.set.default.java}"/>
			<filter token="WRAP_JAVA" value="${script.wrap.java}"/>
			<filter token="WRAP_JAR" value="${script.wrap.jar}"/>
			<filter token="DEFINE_ESCAPE_ARG" value="${script.define.escape_arg}"/>
		</filterset>

		<copy todir="${scripts.dir}" overwrite="true">
			<fileset dir="${scriptsrc.dir}"/>
			<filterset refid="script.filters"/>
		</copy>

		<!-- Make the Unix scripts executable. -->
		<chmod dir="${scripts.dir}" perm="a+x" includes="*" excludes="*.bat"/>

		<touch file="${scripts.stamp}"/>
	</target>
	
	<!-- Test cases (for detectors) -->
	<target name="testjar" depends="classes">
		<javac srcdir="${test.dir}"
		       excludes="${jsr14.excludes}"
		       destdir="${test.dir}"
		       source="1.5"
		       debug="on">
			<classpath refid="tools.classpath"/>
		</javac>
		<jar destfile="${test.jar}">
			<fileset dir="${test.dir}">
				<include name="*.class"/>
			</fileset>
		</jar>
	</target>
	
	<!-- JUnit test cases -->
	<target name="junittests" depends="classes">
		<jar destfile="${junittests.jar}">
			<fileset dir="${classes.dir}">
				<exclude name="${pkg.base}/detect/**"/>
				<include name="**/*Test.class"/>
			</fileset>
		</jar>
	</target>

	<!-- Run JUnit test cases -->
	<target name="runjunit" depends="junittests">
		<echo>Running JUnit test cases for FindBugs...</echo>
		<java dir="."
			fork="true"
			failonerror="true"
			classname="edu.umd.cs.findbugs.tools.junit.JUnitJarRunner">
			<jvmarg value="-Dfindbugs.home=."/>
			<classpath refid="tools.classpath"/>
			<arg value="${junittests.jar}"/>
			<arg value="${engine.jar}"/>
		</java>
	</target>

	<!-- Delete generated files. -->
	<target name="clean">
		<delete>
			<fileset dir="${scripts.dir}" includes="*"/>
		</delete>
		<delete dir="build"/>
		<delete>
			<fileset dir="${test.dir}" includes="*.class,*.jar"/>
		</delete>
		<delete file="${engine.jar}"/>
		<delete file="${coreplugin.jar}"/>
		<delete file="${gui.jar}"/>
	</target>
	
</project>

<!-- vim:set ts=4: -->
