<!--
	FindBugs Test Cases Ant build script.
	Based on original FindBugs Ant Script by Mike Fagan.
	Rewritten 1/5/2005 by David Hovemeyer, 2/6/2006 by Brian Cole.
-->

<project name="findbugsTestCases" default="build">

	<property file="build.properties" />

	<!-- 
	        The local.properties properties file contains the location of findbugs.home 

	        This value is likely to be different for each checkout of the plugin,
	        so the local.properties file is not managed by cvs
	        
	-->
	<property file="local.properties" />
	<property name="findbugs.home" value="../findbugs"/>
	<property name="history.dir" value="history"/>


	<target name="build" depends="classes,runfindbugs" />

	<target name="classes">
		<mkdir dir="build/classes"/>
		<javac srcdir="src/java" destdir="build/classes" source="1.5" debug="on">
			<classpath>
				<pathelement location="build/classes"/>
				<pathelement location="${findbugs.home}/lib/annotations.jar" />
				<pathelement location="${junit.home}/junit.jar"/>
			</classpath>
		</javac>
	</target>

	<taskdef name="findbugs" classname="edu.umd.cs.findbugs.anttask.FindBugsTask" classpath="${findbugs.home}/lib/findbugs-ant.jar"/>


	<target name="runfindbugs" depends="classes">	
		<parallel threadsPerProcessor="1">
			<!--antcall target="historyNormal"/> <!   run findbugs effort=default, then merge or copy results -->
			<antcall target="historyMax"/>       <!-- run findbugs effort=max, then merge or copy results -->
		</parallel>
	</target>

	<target name="runNormal" depends="classes">
		<findbugs home="${findbugs.home}" output="xml" timestampNow="true" reportLevel="low" effort="default" outputFile="build/normal.xml">
			<sourcePath path="${basedir}/src/java" />
			<auxclasspath location="${junit.home}/junit.jar"/>
			<class location="${basedir}/build/classes" />
		</findbugs>
	</target>

	<target name="runMax" depends="classes">
		<findbugs home="${findbugs.home}" output="xml" timestampNow="true" reportLevel="low" effort="max" outputFile="build/max.xml">
			<sourcePath path="${basedir}/src/java" />
			<auxclasspath location="${junit.home}/junit.jar"/>
			<class location="${basedir}/build/classes" />
		</findbugs>
	</target>

	<target name="historyNormal" depends="mergeNormal,copyNormal"/>
	<target name="historyMax" depends="mergeMax,copyMax"/>

	<target name="mergeNormal" depends="runNormal,existance" if="exists.normal">
		<exec dir="." executable="${findbugs.home}/bin/computeBugHistory">
					<arg value="-output" />
					<arg file="${history.dir}/normal.xml" />
					<arg file="${history.dir}/normal.xml" />
					<arg file="build/normal.xml" />
		</exec>
	</target>

	<target name="mergeMax" depends="runMax,existance" if="exists.max">
		<exec dir="." executable="${findbugs.home}/bin/computeBugHistory">
			<arg value="-output" />
			<arg file="${history.dir}/max.xml" />
			<arg file="${history.dir}/max.xml" />
			<arg file="build/max.xml" />
		</exec>
	</target>

	<target name="existance">
		<available property="exists.normal" file="${history.dir}/normal.xml"/>
		<available property="exists.max" file="${history.dir}/max.xml"/>
	</target>

	<target name="copyNormal" depends="runNormal,existance" unless="exists.normal">
		<copy file="build/normal.xml" todir="${history.dir}"/>
	</target>

	<target name="copyMax" depends="runMax,existance" unless="exists.max">
		<copy file="build/max.xml" todir="${history.dir}"/>
	</target>


</project>

<!-- vim:set ts=4: -->
